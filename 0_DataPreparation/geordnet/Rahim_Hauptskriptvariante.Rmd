---
title: "Tabelle für Auswertung"
output: html_notebook
---

alle Librariers laden
```{r}
# Create list with needed libraries
pkgs <- c("readr", "dplyr", "reticulate", "ggplot2", "Metrics","styler","tidyverse","rsample","zoo")

# Load each listed library and check if it is installed and install if necessary
for (pkg in pkgs) {
  if (!require(pkg, character.only = TRUE)) {
    install.packages(pkg)
    library(pkg, character.only = TRUE)
  }
}
```

Vorgegebene Dateien herunterladen Wetter aproximieren und joinen
```{r}
csvwetter <- "https://raw.githubusercontent.com/opencampus-sh/einfuehrung-in-data-science-und-ml/main/wetter.csv"
csvumsatzdaten_gekuerzt <- "https://raw.githubusercontent.com/opencampus-sh/einfuehrung-in-data-science-und-ml/main/umsatzdaten_gekuerzt.csv"
csvkiwo <- "https://raw.githubusercontent.com/opencampus-sh/einfuehrung-in-data-science-und-ml/main/kiwo.csv"

wetter <- read.table(csvwetter, head=TRUE, sep = ",")
umdat <- read.csv(csvumsatzdaten_gekuerzt)
kiwo <- read.csv(csvkiwo)

#Wettercodes und Temperatur approximieren 

wetter$Wettercode <- na.approx(wetter$Wettercode)
wetter$Wettercode <- as.integer(wetter$Wettercode)
wetter$Bewoelkung<- na.approx(wetter$Bewoelkung)
wetter$Bewoelkung <- as.integer(wetter$Bewoelkung)
wetter$Windgeschwindigkeit<- na.approx(wetter$Windgeschwindigkeit)
wetter$Windgeschwindigkeit <- as.integer(wetter$Windgeschwindigkeit)

```
Alle Dateien laden
```{r}


# Definiere den vollständigen Pfad zur CSV-Datei
file_path <- file.path(getwd(), "Datenvorbereitungcsv/Feiertage.csv")
Feiertage <- read.csv(file_path)
Feiertage$Datum <- as.Date(Feiertage$Datum, format = "%Y-%m-%d")

# Definiere den vollständigen Pfad zur CSV-Datei
file_path <- file.path(getwd(), "Datenvorbereitungcsv/test.csv")
testid<- read.csv(file_path)

# Definiere den vollständigen Pfad zur CSV-Datei
file_path <- file.path(getwd(), "Datenvorbereitungcsv/Kreuzfahrten.csv")
Kreuzfahrten<- read.csv(file_path)
Kreuzfahrten$Datum <- as.Date(Kreuzfahrten$Datum, format = "%y-%m-%d")

# Definiere den vollständigen Pfad zur CSV-Datei
file_path <- file.path(getwd(), "Datenvorbereitungcsv/Jahreszeiten.csv")
Jahreszeiten<- read.csv(file_path)
Jahreszeiten$Datum <- as.Date(Jahreszeiten$Datum, format = "%Y-%m-%d")

# Definiere den vollständigen Pfad zur CSV-Datei
file_path <- file.path(getwd(), "Datenvorbereitungcsv/Fußballspiele.csv")
Fussballspiele<- read.csv(file_path)
Fussballspiele$Datum <- as.Date(Fussballspiele$Datum, format = "%Y-%m-%d")

# Definiere den vollständigen Pfad zur CSV-Datei
file_path <- file.path(getwd(), "Datenvorbereitungcsv/Flohmarkt.csv")
Flohmarkt<- read.csv(file_path)
Flohmarkt$Datum <- as.Date(Flohmarkt$Datum, format = "%Y-%m-%d")

# Definiere den vollständigen Pfad zur CSV-Datei
file_path <- file.path(getwd(), "Datenvorbereitungcsv/Ferientage.csv")
Ferientage<- read.csv(file_path)
Ferientage$Datum <- as.Date(Ferientage$Datum, format = "%Y-%m-%d")
```

```{r}
salesid <- full_join(umdat, testid, join_by( Datum, Warengruppe))

Grundtabelle <- full_join(wetter, salesid, by = "Datum") %>%
  full_join(kiwo, by = "Datum")
as_tibble(Grundtabelle)


#Grundtabelle  hat noch den falschen Typ bei Datum, hab das mal angeglichen
Grundtabelle$Datum <- as.Date(Grundtabelle$Datum, format = "%Y-%m-%d")

# Variable wochentag hinzufügen
Grundtabelle$Wochentag <- weekdays(Grundtabelle$Datum)

# Wochentag als faktor
Grundtabelle$Wochentag <- as.factor(Grundtabelle$Wochentag)
```

Alle Dateien Joinen
```{r}
Daten <- full_join(Grundtabelle, Feiertage, by = "Datum") %>%
  full_join(Kreuzfahrten, by = "Datum") %>%
  full_join(Jahreszeiten, by = "Datum") %>%
  full_join(Fussballspiele, by = "Datum") %>%
  full_join(Flohmarkt, by = "Datum") %>%
  full_join(Ferientage, by = "Datum")


#Grundtabelle  hat noch den falschen Typ bei Datum, hab das mal angeglichen
Daten$Datum <- as.Date(Daten$Datum, format = "%Y-%m-%d")


```


Füge Wetter change variables ein, die das Wetter im Verhältnis mit dem Wetter der letzten Woche beerechnen

```{r}

# Ensure Datum is a Date variable.
Daten$Datum <- as.Date(Daten$Datum, format="%Y-%m-%d")

# Order the dataframe by Datum and ungroup if it was previously grouped
Daten <- Daten %>% 
  ungroup() %>%
  arrange(Datum)

# Function to calculate rolling mean for a given column
calculate_rolling_mean <- function(data, column_name) {
  sapply(seq_along(data[[column_name]]), function(i) {
    start_index <- max(1, i - 6)
    current_values <- data[[column_name]][start_index:i]
    mean(current_values, na.rm = TRUE)
  })
}

# Add rolling mean and difference for Temperatur
Daten <- Daten %>%
  mutate(
    RollingMean_temp = calculate_rolling_mean(Daten, "Temperatur"),
    Diff_temp = Temperatur - RollingMean_temp
  )

# Repeat the process for other variables
Daten <- Daten %>%
  mutate(
    RollingMean_wind = calculate_rolling_mean(Daten, "Windgeschwindigkeit"),
    Diff_wind = Windgeschwindigkeit - RollingMean_wind,
    RollingMean_bewoelkung = calculate_rolling_mean(Daten, "Bewoelkung"),
    Diff_bewoelkung = Bewoelkung - RollingMean_bewoelkung
  )

# View the data frame with the new variables
head(Daten)
```

Füge Handballspiele hinzu

````{r}
Daten$Handballspiele <- ifelse(Daten$Datum %in% c("2013-02-13", "2013-02-26", "2013-03-16", "2013-03-27", "2013-03-30", "2013-05-01", "2013-05-14", "2013-06-05", "2013-08-24", "2013-09-11", "2013-09-18", "2013-09-25", "2013-10-05", "2013-10-16", "2013-11-06", "2013-11-27", "2013-12-18", "2013-12-21", "2013-12-26", "2014-02-12", "2014-03-16", "2014-03-26", "2014-04-30", "2014-05-11", "2014-05-24", "2014-08-26", "2014-09-14", "2014-10-05", "2014-10-15", "2014-11-05", "2014-11-12", "2014-11-30", "2014-12-14", "2014-12-23", "2014-12-26", "2015-02-22", "2015-02-25", "2015-03-12", "2015-04-01", "2015-04-05", "2015-04-22", "2015-05-20", "2015-06-05", "2015-09-02", "2015-09-09", "2015-09-20", "2015-09-30", "2015-10-14", "2015-11-15", "2015-11-25", "2015-12-09", "2015-12-23", "2016-02-10", "2016-02-21", "2016-02-27", "2016-04-16", "2016-05-04", "2016-05-08", "2016-05-15", "2016-06-05", "2016-09-11", "2016-09-14", "2016-09-27", "2016-10-19", "2016-11-13", "2016-11-26", "2016-12-11", "2016-12-21", "2016-12-26", "2017-02-19", "2017-02-22", "2017-03-08", "2017-04-02", "2017-04-19", "2017-05-14", "2017-05-28", "2017-06-03", "2017-09-03", "2017-09-07", "2017-09-14", "2017-10-12", "2017-11-02", "2017-11-16", "2017-11-22", "2018-12-06", "2018-12-27", "2019-02-17", "2019-03-14", "2019-03-28", "2019-04-28", "2019-05-12", "2019-05-26", "2019-06-09", "2019-08-25", "2019-09-03", "2019-09-12", "2019-10-10", "2019-10-31", "2019-11-17", "2019-11-24", "2019-12-08", "2019-12-19", "2019-12-22", "2019-12-29"),"1", "0")

#count how many Handball = 1
sum(Daten$Handballspiele == 1)


````


Füge die Einordnung der Temperaturen nach high/medium/low ein
```{r}
# Fügen Sie eine leere Spalte für die Temperaturkategorie hinzu
Daten$Temperaturkategorie <- NA

# Funktion zur Einteilung in drei Kategorien
categorize_temperature <- function(temperature) {
  lower_threshold <- quantile(temperature, 1/3, na.rm = TRUE)
  upper_threshold <- quantile(temperature, 2/3, na.rm = TRUE)
  
  ifelse(temperature < lower_threshold, "niedrig",
         ifelse(temperature < upper_threshold, "mittel", "hoch"))
}

# Anwenden der Funktion auf jede Jahreszeit
data <- Daten %>%
  group_by(Jahreszeit) %>%
  mutate(Temperaturkategorie = categorize_temperature(Temperatur))


# Überprüfen Sie die erstellte Spalte
head(Daten)

```

Funktion erstellen um alle NA's auf Null zu setzten und den Zeitrahmen einhalten
```{r}
set_na_to_zero <- function(data, columns) {
  for (col in columns) {
    data[[col]][is.na(data[[col]])] <- 0
  }
  return(data)
}
#,"id", "Jahreszeit", "Fussballspiel", "Ferien"
columns_to_set_zero <- c(
  "Warengruppe", "Umsatz","Temperatur" ,"Bewoelkung","Windgeschwindigkeit",
  "Feiertag","id", "Jahreszeit", "Fussballspiel", "Ferien", "Temperaturkategorie",
  "KielerWoche", "Wochentag", "Flohmarkt" , "Kreuzfahrtschiffe", "Wettercode", "Handballspiele", "Diff_temp", "Diff_bewoelkung", "Diff_wind"
)

data <- set_na_to_zero(data, columns_to_set_zero)
data <- data %>%
  filter(Datum >= as.Date("2013-07-01") & Datum <= as.Date("2019-07-31"))

```



CSV für die Datenaufbereitung
Feiertage speichern und in eine CSV Schreiben

```{r}

# Dateipfad zur CSV-Datei im aktuellen Arbeitsverzeichnis erstellen
file_path <- "Data.csv"

# Schreiben Sie die CSV-Datei
write.csv(data, file_path, row.names = FALSE)

# Optional: Bestätigungsnachricht ausgeben
cat("CSV-Datei erfolgreich erstellt und im aktuellen Arbeitsverzeichnis gespeichert:", file_path, "\n")


```


